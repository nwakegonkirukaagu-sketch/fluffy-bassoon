<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YouCanHeal Dashboard</title>
<link rel="icon" type="image/png" href="images/youcanheal-logo.png">
<script src="https://www.paypal.com/sdk/js?client-id=AeAkNJQMO6eiYY-v0IsWHNm64M3nHUnFaqKZ0iICehGrAVufHv1c3DGLNPXRkbKjjTJ_0cjN0Slc5tZz&vault=true&intent=subscription"></script>
<style>
:root {
/* Light theme - calm and soothing */
--bg: #f8fafc;
--card: #ffffff;
--accent: #10b981; /* Emerald green - calming */
--accent-2: #3b82f6; /* Blue - trustworthy */
--accent-3: #9B59B6; /* Gentle purple */
--accent-soft: #d1fae5; /* Light green tint */
--text: #1f2937; /* Dark gray for readability */
--text-secondary: #374151; /* Medium gray */
--muted: #6b7280; /* Light gray for secondary text */
--border: #e5e7eb;
--hover: #f3f4f6;
--button: var(--accent);
--button-hover: #059669;
--alert: #FFBF00; /* amber */
--error: #FF6F61; /* soft coral */
}

[data-theme="dark"] {
/* Dark theme ‚Äî calming, high readability */
--bg: #121212; /* soft dark */
--card: #1E1E1E; /* elevated surfaces */
--accent: #A3D3B8; /* Soft green for highlights */
--accent-2: #4A90E2; /* Calming blue for buttons/links */
--accent-3: #9B59B6; /* Gentle purple for accents */
--accent-soft: #1a2a25; /* subtle green tint */
--text: #E0E0E0; /* primary text */
--text-secondary: #B0B0B0; /* secondary text */
--muted: #B0B0B0; /* muted */
--border: #2A2A2A;
--hover: #1A1A1A;
--button: #4A90E2; /* primary interactive */
--button-hover: #6AA6EA;
--alert: #FFBF00;
--error: #FF6F61;
}

* {
box-sizing: border-box;
transition: background 0.3s ease, color 0.3s ease, border 0.3s ease;
}

body {
margin: 0;
font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
background: linear-gradient(135deg, var(--bg) 0%, var(--hover) 100%);
color: var(--text);
min-height: 100vh;
line-height: 1.6;
}

header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 16px 24px;
background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
color: white;
box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
position: sticky;
top: 0;
z-index: 100;
backdrop-filter: blur(10px);
}

header h1 {
font-size: 1.4rem;
margin: 0;
letter-spacing: 0.5px;
}

header nav a {
color: white;
text-decoration: none;
margin-left: 16px;
font-weight: 600;
text-shadow: 0 0 8px rgba(255,255,255,0.3);
}

.container {
max-width: 1100px;
margin: 30px auto;
padding: 0 18px;
display: grid;
grid-template-columns: repeat(12, 1fr);
gap: 20px;
}

.card {
background: var(--card);
border-radius: 16px;
padding: 24px;
box-shadow: 0 4px 20px rgba(16, 185, 129, 0.08);
border: 1px solid var(--border);
transition: all 0.3s ease;
backdrop-filter: blur(10px);
}

.card:hover {
transform: translateY(-3px);
box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
border-color: var(--accent);
}

.big { grid-column: span 8; }
.side { grid-column: span 4; }
@media(max-width: 900px) {
.big, .side { grid-column: span 12; }
}

h2 {
margin: 0 0 12px 0;
color: var(--text);
font-weight: 600;
font-size: 1.3rem;
}

h2::before {
content: '';
display: inline-block;
width: 4px;
height: 20px;
background: linear-gradient(135deg, var(--accent), var(--accent-2));
border-radius: 2px;
margin-right: 8px;
vertical-align: middle;
}

.muted {
color: var(--muted);
font-size: 0.95rem;
}

.btn {
background: var(--button);
color: white;
border: none;
padding: 12px 16px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
box-shadow: 0 4px 15px rgba(74, 144, 226, 0.25);
transition: all 0.2s ease;
font-size: 0.95rem;
}

.btn:hover {
background: var(--button-hover);
transform: translateY(-1px);
box-shadow: 0 6px 20px rgba(74, 144, 226, 0.35);
}

.smallbtn {
background: var(--card);
border: 1px solid var(--accent-2);
color: var(--accent-2);
padding: 8px 12px;
border-radius: 8px;
cursor: pointer;
font-weight: 500;
transition: all 0.2s ease;
}

.smallbtn:hover {
background: var(--accent-2);
color: white;
transform: translateY(-1px);
}

#chatBox {
height: 260px;
overflow: auto;
padding: 15px;
border-radius: 12px;
background: var(--accent-soft);
border: 1px solid var(--border);
scrollbar-width: thin;
scrollbar-color: var(--accent) var(--hover);
}

.msg {
padding: 12px 15px;
border-radius: 12px;
margin-bottom: 10px;
max-width: 85%;
line-height: 1.5;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.msg.user {
background: var(--accent-2);
color: white;
margin-left: auto;
box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
}

.msg.ai {
background: var(--card);
color: var(--text);
border: 1px solid var(--border);
box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
}

.theme-toggle {
background: rgba(255,255,255,0.2);
border: 1px solid rgba(255,255,255,0.3);
color: white;
padding: 8px 12px;
border-radius: 8px;
cursor: pointer;
font-weight: 500;
transition: all 0.2s ease;
backdrop-filter: blur(10px);
}

.theme-toggle:hover {
background: rgba(255,255,255,0.3);
transform: translateY(-1px);
}

footer {
text-align: center;
color: var(--muted);
padding: 20px;
font-size: 0.9rem;
}

/* Input focus states and additional styling */
input:focus {
outline: none;
border-color: var(--accent);
box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

/* Mood button grid styling */
.mood-btns .btn {
font-size: 1rem;
padding: 10px 8px;
}

/* List styling improvements */
ul {
line-height: 1.7;
padding-left: 20px;
color: var(--text-secondary);
}

li {
margin-bottom: 8px;
}

li strong {
color: var(--accent);
font-weight: 600;
}

/* Username text styling */
#username {
color: rgba(255,255,255,0.9);
font-size: 0.9rem;
font-weight: 500;
}

/* Smooth scrollbar for chat */
#chatBox::-webkit-scrollbar {
width: 6px;
}

#chatBox::-webkit-scrollbar-track {
background: var(--hover);
border-radius: 3px;
}

#chatBox::-webkit-scrollbar-thumb {
background: var(--accent);
border-radius: 3px;
}

#chatBox::-webkit-scrollbar-thumb:hover {
background: #059669;
}

/* Logo styling */
.logo {
height: 50px;
width: auto;
filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.4));
transition: transform 0.3s ease, filter 0.3s ease;
}

.logo:hover {
transform: scale(1.05);
filter: drop-shadow(0 0 12px rgba(59, 130, 246, 0.5));
}

.logo-area {
display: flex;
align-items: center;
}

#donationFab {
position: fixed;
bottom: 22px;
right: 22px;
background: linear-gradient(135deg,#d8b4fe,#a78bfa);
color: white;
border: none;
padding: 14px 18px;
border-radius: 999px;
font-weight: 600;
cursor: pointer;
box-shadow: 0 8px 25px rgba(167,139,250,.45);
display: inline-flex;
align-items: center;
gap: 6px;
z-index: 80;
animation: donationPulse 3s ease-in-out infinite;
}

#donationFab:hover {
box-shadow: 0 10px 32px rgba(167,139,250,.6);
}

@keyframes donationPulse {
0%,100% { transform: translateY(0); box-shadow: 0 8px 25px rgba(167,139,250,.45); }
50% { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(167,139,250,.55); }
}

#donationModal {
position: fixed;
inset: 0;
background: rgba(0,0,0,.45);
display: flex;
align-items: center;
justify-content: center;
z-index: 90;
}

.donation-card {
background: var(--card, #ffffff);
border-radius: 18px;
padding: 24px;
width: 320px;
box-shadow: 0 20px 45px rgba(0,0,0,0.25);
position: relative;
border: 1px solid var(--border);
text-align: center;
}

.donation-card h2 {
margin-top: 6px;
margin-bottom: 8px;
}

#donationClose {
position: absolute;
top: 10px;
right: 10px;
border: none;
background: transparent;
font-size: 20px;
cursor: pointer;
color: var(--muted);
}

.donation-card .donate-amount {
width: 100%;
padding: 10px 12px;
border-radius: 10px;
border: 1px solid var(--border);
margin-top: 10px;
background: var(--hover);
color: var(--text);
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
}

.donation-card .donate-amount.active {
background: linear-gradient(135deg,#d8b4fe,#a78bfa);
color: white;
border-color: transparent;
}

#stripeDonateBtn {
width: 100%;
margin-top: 14px;
border-radius: 999px;
}

#paypal-button-container {
margin-top: 12px;
}

#contactBtn {
position: fixed;
bottom: 22px;
left: 22px;
background: rgba(15,23,42,0.92);
color: #f9fafb;
border: none;
padding: 12px 16px;
border-radius: 999px;
font-weight: 600;
cursor: pointer;
box-shadow: 0 8px 22px rgba(15,23,42,0.45);
z-index: 80;
display: inline-flex;
align-items: center;
gap: 6px;
}

#contactBtn:hover {
box-shadow: 0 12px 28px rgba(15,23,42,0.55);
}

#contactModal {
position: fixed;
inset: 0;
background: rgba(0,0,0,0.5);
display: flex;
align-items: center;
justify-content: center;
z-index: 95;
}

.contact-card {
background: var(--card, #ffffff);
border-radius: 18px;
padding: 26px;
width: 340px;
max-width: 90vw;
box-shadow: 0 18px 40px rgba(0,0,0,0.25);
border: 1px solid var(--border);
position: relative;
}

#contactClose {
position: absolute;
top: 12px;
right: 12px;
border: none;
background: transparent;
font-size: 20px;
cursor: pointer;
color: var(--muted);
}

.contact-card h2 {
margin: 0 0 6px;
}

.contact-card p {
margin: 0;
color: var(--muted);
font-size: 0.95rem;
}

.contact-card form {
display: flex;
flex-direction: column;
gap: 12px;
margin-top: 18px;
}

.contact-card input,
.contact-card textarea {
border-radius: 10px;
border: 1px solid var(--border);
padding: 10px 12px;
font-size: 0.95rem;
background: var(--hover);
color: var(--text);
resize: vertical;
}

.contact-note {
font-size: 0.82rem;
color: var(--muted);
text-align: left;
}

.contact-note a {
color: var(--accent-2);
}
</style>
</head>
<body data-theme="light">
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const SUPABASE_URL = "https://hrpxfnrizypnqwsiasqw.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhycHhmbnJpenlwbnF3aWFzcXciLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc1OTAwNjUyNSwiZXhwIjoyMDc0NTgyNTI1fQ.4btbG22BF7WWtCvq1Du7Bo0aLcKHZIUV4MBwPQW53eY";

window.SUPABASE_URL = SUPABASE_URL;
window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY;

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

(async () => {
  try {
    if (window.location.hash.includes("access_token")) {
      await supabase.auth.getSessionFromUrl({ storeSession: true });
      window.history.replaceState({}, document.title, "/dashboard.html");
    }

    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      window.location.replace("/index.html");
      return;
    }

    const usernameEl = document.getElementById("username");
    if (usernameEl) {
      usernameEl.textContent = session.user.email;
    }

    window.__dashboardSupabaseClient = supabase;
    window.__dashboardUser = session.user;
    window.dispatchEvent(new CustomEvent("dashboard-auth-ready"));

    console.log("‚úÖ Authenticated:", session.user.email);
  } catch (err) {
    console.error("Auth failed:", err);
    window.location.replace("/index.html");
  }
})();
</script>
<header>
<div class="logo-area">
<img src="images/youcanheal-logo.png" alt="YouCanHeal Logo" class="logo">
</div>
<nav>
<a href="#boost">Daily Boost</a>
<a href="#steps">Steps</a>
<a href="#luna">Luna</a>
<a href="#coping">Coping</a>
<a href="/meditations.html">Meditations</a>
</nav>
<div style="display: flex; align-items: center; gap: 10px;">
<span id="username" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Guest</span>
<button class="theme-toggle" id="themeToggle">üåô Dark</button>
<button class="smallbtn" onclick="signOut()">Sign Out</button>
</div>
</header>

<div class="container">
<!-- Daily Boost -->
<div class="card big" id="boost">
<h2>üå∏ Today's Gentle Boost</h2>
<p id="boostText" class="muted">Loading your gentle message...</p>
<button class="btn" onclick="getBoost()">Get Today's Boost</button>
<div id="stepsDisplay" style="margin-top: 15px;" class="muted"></div>
</div>

<!-- Step Counter -->
<div class="card side" id="steps">
<h2>üö∂‚Äç‚ôÄÔ∏è Daily Steps</h2>
<p>Steps Today: <strong id="stepsCount">0</strong></p>
<input type="number" id="addStepsInput" placeholder="Add steps..." style="width: 100%; margin: 10px 0; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); transition: all 0.2s ease;" />
<button class="btn" onclick="addSteps()">+ Add Steps</button>
</div>

<!-- Mood Checker -->
<div class="card side" id="mood">
<h2>üí≠ Mood Checker</h2>
<p class="muted">How are you feeling today?</p>
<div class="mood-btns" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0;">
<button class="btn" onclick="logMood('Happy')" style="font-size: 1.1rem;">üòä Happy</button>
<button class="btn" onclick="logMood('Okay')" style="font-size: 1.1rem;">üòê Okay</button>
<button class="btn" onclick="logMood('Sad')" style="font-size: 1.1rem;">üòî Sad</button>
<button class="btn" onclick="logMood('Anxious')" style="font-size: 1.1rem;">üò∞ Anxious</button>
</div>
<div id="moodLog" class="muted" style="margin-top: 10px;">No moods logged yet.</div>
</div>

<!-- Featured Meditation -->
<div class="card side" id="featured-meditation">
<h2>üéß Featured Meditation</h2>
<div class="muted" id="miniTitle">Loading track...</div>
<div class="muted" id="miniBy" style="margin-bottom:8px;">‚Äî</div>
<div style="display:flex; gap:8px; align-items:center;">
  <button class="btn" id="miniPlayBtn">Play</button>
  <button class="smallbtn" onclick="window.location.href='meditations.html'">Open Library</button>
  <audio id="miniAudio" preload="auto" style="display:none;"></audio>
  </div>
</div>

<!-- Chat with Luna -->
<div class="card big" id="luna">
<h2>üåô Chat with Luna</h2>
<div id="chatBox">
<div class="msg ai">Hi there! üíõ I'm Luna, your wellbeing companion. How are you feeling today?</div>
</div>
<div style="display: flex; gap: 8px; margin-top: 10px;">
<input type="text" id="chatInput" placeholder="Say hi to Luna..." style="flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--card); color: var(--text); transition: all 0.2s ease;" />
<button class="btn" id="sendBtn" onclick="sendMessage()">Send</button>
<button class="smallbtn" onclick="clearChat()">Clear</button>
</div>
<p class="muted" style="margin-top: 8px; font-size: 0.85rem;">Luna provides emotional support and is not a substitute for medical advice.</p>
</div>

<!-- Coping Library -->
<div class="card side" id="coping">
<h2>üåø Coping Library</h2>
<ul style="line-height: 1.6; padding-left: 20px;">
<li><strong>Deep Breathing:</strong> Inhale 4s, hold 4s, exhale 4s. Repeat 5x.</li>
<li><strong>5-4-3-2-1 Grounding:</strong> Notice 5 things you see, 4 feel, 3 hear, 2 smell, 1 taste.</li>
<li><strong>Mini Gratitude:</strong> Write 3 things that made you smile today.</li>
<li><strong>Gentle Movement:</strong> Stretch your arms, roll your shoulders, or take a short walk.</li>
<li><strong>Self-Compassion:</strong> Speak to yourself like you would to a dear friend.</li>
</ul>
</div>
</div>

<footer>
  <p>
    ¬© YouCanHeal ‚Ä¢ All rights reserved ‚Ä¢
    <a href="privacy.html">Privacy & Cookies</a>
  </p>
  <p style="font-size: 0.85rem; opacity: 0.8;">
    This platform provides general wellbeing support and is not medical advice.
  </p>
</footer>

<script>
const yearEl = document.getElementById("year");
if (yearEl) {
  yearEl.textContent = new Date().getFullYear();
}

// Dark mode toggle functionality
const themeToggle = document.getElementById('themeToggle');
function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.setAttribute('data-theme', 'dark');
    themeToggle.textContent = '‚òÄÔ∏è Light';
  } else {
    document.body.setAttribute('data-theme', 'light');
    themeToggle.textContent = 'üåô Dark';
  }
  localStorage.setItem('yc_theme', theme);
}

// Initialize theme
const savedTheme = localStorage.getItem('yc_theme') || 'light';
applyTheme(savedTheme);

themeToggle.addEventListener('click', () => {
  const currentTheme = localStorage.getItem('yc_theme') || 'light';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  applyTheme(newTheme);
});

let supabaseClient = null;
let currentUser = null;

function syncAuthContext() {
  supabaseClient = window.__dashboardSupabaseClient || supabaseClient;
  currentUser = window.__dashboardUser || currentUser;
  return Boolean(supabaseClient && currentUser);
}

// Initialize Gentle Daily Boost system
async function initializeGentleBoost() {
  if (!currentUser) {
    console.warn('‚ö†Ô∏è Missing user context; skipping Gentle Boost init');
    return;
  }
  try {
    // Register user with backend if needed
    const response = await fetch('http://localhost:5000/api/gentle-boost/user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        email: currentUser.email,
        name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0]
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log('‚úÖ Gentle Boost user registered:', data.message);
      
      // Load today's data
      await loadTodayData();
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Backend connection failed:', error);
    // Continue with local functionality
    getBoost();
  }
}

// Load today's boost and steps data
async function loadTodayData() {
  try {
    const response = await fetch('http://localhost:5000/api/gentle-boost/today', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // Update steps display
      document.getElementById('stepsCount').textContent = data.steps || 0;
      
      // Update boost display
      if (data.boost) {
        document.getElementById('boostText').textContent = data.boost.task_text;
      } else {
        getBoost(); // Fallback to local boost
      }
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Failed to load today\'s data:', error);
    getBoost(); // Fallback to local boost
  }
}

// Step tracker
let localSteps = 0;
async function addSteps() {
  const input = document.getElementById("addStepsInput");
  const stepsToAdd = Number(input.value);
  
  if (stepsToAdd <= 0) {
    alert('Please enter a valid number of steps');
    return;
  }
  
  try {
    // Try backend first
    const response = await fetch('http://localhost:5000/api/gentle-boost/steps', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ steps: stepsToAdd })
    });
    
    if (response.ok) {
      const data = await response.json();
      document.getElementById("stepsCount").textContent = data.totalSteps;
    } else {
      throw new Error('Backend failed');
    }
  } catch (error) {
    // Fallback to local storage
    localSteps += stepsToAdd;
    document.getElementById("stepsCount").textContent = localSteps;
  }
  
  input.value = "";
}

// Daily boosts
const boosts = [
"You are doing better than you think üíõ",
"Tiny steps are still progress üå±",
"Resting is part of healing üå∏",
"You are growing in calm and confidence üåø",
"You deserve the same care you give others üí´",
"Every breath is a chance to begin again üåÖ",
"Your feelings are valid and temporary üåô",
"Small acts of self-care create big changes ‚ú®",
"You are stronger than you realize üí™",
"Progress isn't always visible, but it's happening üå∏"
];

function getBoost() {
  const msg = boosts[Math.floor(Math.random() * boosts.length)];
  document.getElementById("boostText").textContent = msg;
}

// Mood checker
function logMood(mood) {
  const log = document.getElementById("moodLog");
  const time = new Date().toLocaleTimeString();
  log.textContent = `Last mood: ${mood} (${time})`;
  
  // Store mood locally
  const today = new Date().toDateString();
  const moods = JSON.parse(localStorage.getItem('moods') || '{}');
  if (!moods[today]) moods[today] = [];
  moods[today].push({ mood, time });
  localStorage.setItem('moods', JSON.stringify(moods));
}

// Enhanced Luna chat with backend integration
async function sendMessage() {
  const chatInput = document.getElementById("chatInput");
  const chatBox = document.getElementById("chatBox");
  const userMsg = chatInput.value.trim();
  
  if (!userMsg) return;
  
  // Add user message
  const userDiv = document.createElement("div");
  userDiv.className = "msg user";
  userDiv.innerHTML = `<strong>You:</strong> ${userMsg}`;
  chatBox.appendChild(userDiv);
  chatInput.value = "";
  
  // Add typing indicator
  const typingDiv = document.createElement("div");
  typingDiv.className = "msg ai";
  typingDiv.style.opacity = "0.7";
  typingDiv.innerHTML = `<strong>Luna:</strong> <em>typing...</em>`;
  chatBox.appendChild(typingDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  
  try {
    // Try backend Luna chat
    const response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ 
        message: userMsg
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      typingDiv.remove();
      
      const lunaDiv = document.createElement("div");
      lunaDiv.className = "msg ai";
      if (data.isCrisisResponse) {
        lunaDiv.style.borderLeft = "4px solid #ff6b6b";
        lunaDiv.style.background = "rgba(255, 107, 107, 0.1)";
      }
      
      // Format response with line breaks
      const formattedReply = data.reply.replace(/\n/g, '<br>');
      lunaDiv.innerHTML = `<strong>Luna:</strong> ${formattedReply}`;
      
      chatBox.appendChild(lunaDiv);
    } else {
      throw new Error('Backend unavailable');
    }
  } catch (error) {
    console.warn('Luna backend failed, using fallback:', error);
    typingDiv.remove();
    
    // Fallback to local responses
    const reply = document.createElement("div");
    reply.className = "msg ai";
    reply.innerHTML = `<strong>Luna:</strong> ${getEmpatheticReply(userMsg)}`;
    chatBox.appendChild(reply);
  }
  
  chatBox.scrollTop = chatBox.scrollHeight;
}

function getEmpatheticReply(text) {
  const lower = text.toLowerCase();
  
  // Enhanced crisis detection
  if (lower.includes("hurt myself") || lower.includes("kill myself") || lower.includes("suicide")) {
    return `I'm really concerned about you üíõ Please reach out for immediate help:<br><br>
    üÜò <strong>Crisis Support:</strong><br>
    ‚Ä¢ Emergency: 911<br>
    ‚Ä¢ Crisis Text Line: Text HOME to 741741<br>
    ‚Ä¢ Suicide Prevention: 988<br><br>
    You matter and there are people who want to help you through this. üåô`;
  }
  
  if (lower.includes("sad") || lower.includes("tired") || lower.includes("depressed"))
    return "I'm sorry you're feeling that way üíõ Remember it's okay to rest ‚Äî small comforts matter. You're doing the best you can.";
  if (lower.includes("happy") || lower.includes("good") || lower.includes("better"))
    return "That's lovely to hear üå∏ Keep noticing those good moments! They matter more than you know.";
  if (lower.includes("anxious") || lower.includes("worried") || lower.includes("scared"))
    return "Breathe gently. You are safe in this moment üåø Try the 5-4-3-2-1 grounding exercise from the coping library.";
  if (lower.includes("stress") || lower.includes("overwhelmed"))
    return "It sounds like you're carrying a lot right now üí´ Remember: you don't have to do everything at once. One small step is enough.";
  
  return "Thank you for sharing with me üåô You're doing your best, and that's enough. I'm here to listen whenever you need support.";
}

// Mini featured meditation player
async function initMiniPlayer() {
  try {
    const res = await fetch('media/manifest.json');
    if (!res.ok) throw new Error('manifest request failed');
    const manifest = await res.json();
    const t = (manifest.meditations && manifest.meditations[0]) || (manifest.whiteNoises && manifest.whiteNoises[0]);
    if (!t) return;

    const titleEl = document.getElementById('miniTitle');
    const byEl = document.getElementById('miniBy');
    const audio = document.getElementById('miniAudio');
    const btn = document.getElementById('miniPlayBtn');
    if (!titleEl || !byEl || !audio || !btn) return;

    titleEl.textContent = t.label;
    byEl.textContent = `by ${t.author}`;
    audio.src = t.file;

    let playing = false;
    btn.addEventListener('click', async () => {
      if (!playing) {
        try { await audio.play(); } catch(e) {}
        playing = true;
        btn.textContent = 'Pause';
      } else {
        audio.pause();
        playing = false;
        btn.textContent = 'Play';
      }
    });

    audio.addEventListener('ended', () => {
      playing = false;
      btn.textContent = 'Play';
    });
  } catch (e) {
    console.warn('Mini player init failed:', e);
  }
}

// Clear chat history
async function clearChat() {
  try {
    await fetch('/api/chat/reset', {
      method: 'POST',
      credentials: 'include'
    });
  } catch (error) {
    console.warn('Failed to reset backend chat:', error);
  }
  
  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML = `
    <div class="msg ai">
      <strong>Luna:</strong> Hi there üíõ I'm here to listen and support you. How are you feeling today?
    </div>
  `;
}

// Sign out function
async function signOut() {
  try {
    if (supabaseClient) {
      await supabaseClient.auth.signOut();
    }
  } catch (error) {
    console.error('Sign out error:', error);
  }
  window.location.href = 'index.html';
}

// Allow Enter key for chat
document.getElementById('chatInput')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

// Allow Enter key for steps
document.getElementById('addStepsInput')?.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    addSteps();
  }
});

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', () => {
  initMiniPlayer();

  const startDashboard = () => {
    if (!syncAuthContext()) {
      return;
    }
    initializeGentleBoost();
  };

  if (syncAuthContext()) {
    startDashboard();
  } else {
    window.addEventListener('dashboard-auth-ready', startDashboard, { once: true });
  }
});

// Cookie consent banner
if(!localStorage.getItem('yc_cookie')){
const banner = document.getElementById('cookie-banner');
banner.style.display='block';
document.getElementById('cookie-accept').onclick=()=>{
localStorage.setItem('yc_cookie','true');
banner.style.display='none';
};
}

const DONATION_PAYPAL_PLANS = {
  2: "P-6PU50610GN123364SNE27HYY",
  5: "P-8J411952AV1634600NE27J6Q"
};

const donationFab = document.getElementById("donationFab");
const donationModal = document.getElementById("donationModal");
const donationCloseBtn = document.getElementById("donationClose");
const amountButtons = Array.from(document.querySelectorAll(".donate-amount"));
const stripeBtn = document.getElementById("stripeDonateBtn");
const contactBtn = document.getElementById("contactBtn");
const contactModal = document.getElementById("contactModal");
const contactCloseBtn = document.getElementById("contactClose");

const getSelectedAmount = () => {
  const active = amountButtons.find((btn) => btn.classList.contains("active")) || amountButtons[0];
  return Number(active.dataset.amt);
};

const setActiveAmount = (button) => {
  amountButtons.forEach((btn) => btn.classList.remove("active"));
  button.classList.add("active");
};

amountButtons.forEach((button, index) => {
  if (index === 0) button.classList.add("active");
  button.addEventListener("click", () => setActiveAmount(button));
});

if (donationFab && donationModal && donationCloseBtn) {
  donationFab.addEventListener("click", () => {
    donationModal.hidden = false;
  });

  donationCloseBtn.addEventListener("click", () => {
    donationModal.hidden = true;
  });

  donationModal.addEventListener("click", (event) => {
    if (event.target === donationModal) {
      donationModal.hidden = true;
    }
  });
}

stripeBtn?.addEventListener("click", async () => {
  if (!supabaseClient) {
    alert("Please wait until authentication completes.");
    return;
  }
  const amount = getSelectedAmount();
  stripeBtn.disabled = true;
  const original = stripeBtn.textContent;
  stripeBtn.textContent = "Opening checkout‚Ä¶";
  try {
    const response = await fetch(`${window.BACKEND_URL || "http://localhost:3000"}/api/create-session`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount, recurring: true })
    });
    if (!response.ok) throw new Error("Failed to start checkout");
    const data = await response.json();
    if (!data?.url) throw new Error("Missing checkout URL");
    window.location.href = data.url;
  } catch (err) {
    console.error("Stripe donation error", err);
    alert("Sorry, we could not start the donation checkout. Please try again later.");
  } finally {
    stripeBtn.disabled = false;
    stripeBtn.textContent = original;
  }
});

if (window.paypal?.Buttons) {
  window.paypal.Buttons({
    style: { layout: "vertical", color: "gold", shape: "rect", label: "subscribe" },
    createSubscription(data, actions) {
      const amount = getSelectedAmount();
      const plan = DONATION_PAYPAL_PLANS[amount];
      if (!plan) {
        alert("Please select a supported monthly amount (currently ¬£2 or ¬£5).");
        return;
      }
      return actions.subscription.create({ plan_id: plan });
    },
    onApprove(details) {
      alert("Thank you for supporting YouCanHeal via PayPal! üíõ");
      console.log("PayPal subscription active", details.subscriptionID);
      donationModal.hidden = true;
    },
    onError(err) {
      console.error("PayPal error", err);
      alert("PayPal could not start the subscription. Please try again.");
    }
  }).render("#paypal-button-container");
} else {
  console.warn("PayPal SDK not available; donation button skipped.");
}

const closeContactModal = () => {
  if (contactModal) contactModal.hidden = true;
};

contactBtn?.addEventListener("click", () => {
  if (contactModal) contactModal.hidden = false;
});

contactCloseBtn?.addEventListener("click", closeContactModal);

contactModal?.addEventListener("click", (event) => {
  if (event.target === contactModal) {
    closeContactModal();
  }
});
</script>

<div id="cookie-banner" style="display:none;position:fixed;bottom:0;left:0;right:0;background:#222;color:#fff;padding:12px;text-align:center;font-size:0.9rem;">
üç™ We use cookies to improve your experience. By continuing, you agree to our <a href="#" style="color:#ffc107;">cookie policy</a>.
<button id="cookie-accept" style="margin-left:10px;padding:4px 10px;border:none;border-radius:6px;background:#ffc107;color:#000;font-weight:bold;cursor:pointer;">OK</button>
</div>

<button id="donationFab" aria-label="Support Us">üíú Support Us</button>

<div id="donationModal" hidden>
  <div class="donation-card">
    <button id="donationClose">√ó</button>
    <h2>Support YouCanHeal</h2>
    <p>Your support keeps this platform free üíõ</p>

    <button class="donate-amount" data-amt="2">¬£2 / month</button>
    <button class="donate-amount" data-amt="5">¬£5 / month</button>

    <button id="stripeDonateBtn" class="btn" type="button">Donate via Stripe</button>
    <div id="paypal-button-container"></div>
  </div>
</div>

<button id="contactBtn" aria-label="Contact YouCanHeal">üì© Contact</button>

<div id="contactModal" hidden>
  <div class="contact-card">
    <button id="contactClose" type="button">√ó</button>
    <h2>Contact YouCanHeal</h2>
    <p>We reply from our Zoho Mail inbox within 2 working days.</p>

    <form action="mailto:support@youcanheal.co.uk" method="post" enctype="text/plain">
      <input type="email" name="replyTo" placeholder="Your email" required />
      <textarea name="message" rows="4" placeholder="How can we help?" required></textarea>
      <p class="contact-note">Partner enquiries: <a href="mailto:partners@youcanheal.co.uk">partners@youcanheal.co.uk</a></p>
      <button type="submit" class="btn">Send via Zoho Mail</button>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------- SUPABASE CONFIG ---------- */
const SUPABASE_URL = "https://hrpxfnrizypnqwsiasqw.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ---------- AUTH GUARD ---------- */
async function protectDashboard() {
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    window.location.replace("index.html");
    return;
  }

  // expose for rest of dashboard
  window.supabaseClient = supabase;
  window.currentUser = session.user;

  const username = document.getElementById("username");
  if (username) username.textContent = session.user.email;

  console.info("‚úÖ Logged in:", session.user.email);
}

protectDashboard();

/* ---------- SIGN OUT ---------- */
async function signOut() {
  await supabase.auth.signOut();
  window.location.replace("index.html");
}
</script>

</body>

</html>
